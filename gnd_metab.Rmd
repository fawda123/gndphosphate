---
output:
  html_document:
    keep_md: yes
---

```{r echo = FALSE, message = F}
library(ggplot2)
library(dplyr)
library(gridExtra)
library(SWMPr)
```

## Estimates of ecosystem metabolism for Grand Bay wq stations

The data were downloaded from CDMO, imported into R, and processed with SWMPr.  Water quality stations included Bayou Cumbest (bc), Bangs Lake (bl), and Point Aux Chenes (pc). Water quality data were combined with weather data from Crooked Bayou.

```{r eval = FALSE}
library(SWMPr)
library(dplyr)

# process met for metab
met <- import_local('C:/Users/mbeck/Desktop/813213.zip', 'gndcrmet')
met_proc <- qaqc(met, qaqc_keep = c(0, 4)) %>% 
  subset(., select = c('atemp', 'bp', 'wspd'), subset = '2005-01-01 0:0', operator = '>=')

# wq stations to process
sta <- c('gndbcwq', 'gndblwq', 'gndpcwq')

# output list to append results
gnd_metab <- vector('list', length = length(sta))
names(gnd_metab) <- sta

# iterate through stations
for(st in sta){
  
  # import
  dat <- import_local('C:/Users/mbeck/Desktop/813213.zip', st, trace = TRUE)
  
  # qaqc, subset, combine with met, get ecometab
  dat_proc <- qaqc(dat, qaqc_keep = c(0, 4)) %>% 
    subset(., select = c('do_mgl', 'depth', 'temp', 'sal'), subset = '2005-01-01 0:0', operator = '>=') %>% 
    comb(., met_proc, timestep = 15) %>% 
    ecometab(., trace = TRUE)
  
  # append to output list
  gnd_metab[[st]] <- dat_proc
  
}

# save data file
save(gnd_metab, file = 'gnd_metab.RData')
```

Plots of DO and ecosystem metabolism by station:

```{r fig.height = 6, fig.width = 10, warning = F}
load(file = 'gnd_metab.RData')

for(i in 1:length(gnd_metab)){
  
  # station
  dat <- gnd_metab[[i]]
  
  # do plot
  p1 <- ggplot(dat, aes(x = datetimestamp, y = do_mgl)) +
    geom_line() + 
    theme_minimal() +
    theme(axis.title.x = element_blank()) + 
    ggtitle(names(gnd_metab)[i])
  
  # metab plot
  p2 <- plot_metab(dat) +
    theme_minimal() +
    theme(legend.position = 'top', legend.title = element_blank(), axis.title.x = element_blank())
  
  grid.arrange(p1, p2, ncol = 1)
   
}

```

Tabular summaries can be obtained with `aggremetab`.

```{r}
st <- 'gndbcwq'
summ <- aggremetab(gnd_metab[[st]], by = 'years')
knitr::kable(summ)
```

